<!-- Hydraulic-Control-v2.1.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- same meta + styles as before -->
</head>
<body>
    <!-- same HTML structure -->

    <script type="module">
        // ── Constants & Config ───────────────────────────────────────
        const CONFIG = {
            UART_SERVICE: '0000ffe0-0000-1000-8000-00805f9b34fb',
            UART_CHAR:    '0000ffe1-0000-1000-8000-00805f9b34fb',
            DEVICE_NAME_PREFIX: 'HC',
            VIBRATION_MS: 12,
            CONFIRM_AUGER: true,
            CONFIRM_EMERGENCY: true
        };

        // ── State ────────────────────────────────────────────────────
        let appState = {
            device: null,
            characteristic: null,
            deviceName: null
        };

        // ── DOM Helpers ──────────────────────────────────────────────
        const $ = id => document.getElementById(id);
        const statusEl = $('status');
        const deviceStatusEl = $('deviceStatus');

        const setStatus = (msg, isError = false) => {
            statusEl.textContent = msg;
            statusEl.className = isError ? 'status-error' : '';
        };

        // ── BLE Communication ────────────────────────────────────────
        const ble = {
            async connect() { /* ... same as before ... */ },
            async disconnect() { /* ... */ },
            async send(cmd) {
                if (!appState.characteristic) return false;
                try {
                    await appState.characteristic.writeValue(
                        new TextEncoder().encode(cmd + '\n')
                    );
                    console.log('→', cmd);
                    return true;
                } catch (err) {
                    setStatus(`Send failed: ${err.message}`, true);
                    return false;
                }
            }
        };

        // ── Button Handlers ──────────────────────────────────────────
        const controls = {
            makeHoldButton(extendId, retractId, extendCmd, retractCmd, stopCmd) {
                // same improved hold logic as v2
            },

            async augerAction(cmd, label) {
                if (CONFIG.CONFIRM_AUGER && !confirm(`Really ${label} the auger?`)) return;
                await ble.send(cmd);
            },

            async emergencyStop() {
                if (CONFIG.CONFIRM_EMERGENCY && !confirm('EMERGENCY STOP ALL?')) return;
                await ble.send('S');
                if (navigator.vibrate) navigator.vibrate([25, 50, 25]);
            }
        };

        // ── Initialization ───────────────────────────────────────────
        function init() {
            // Setup all hold buttons
            controls.makeHoldButton('c1Extend', 'c1Retract', '1E', '1R', '1S');
            controls.makeHoldButton('c2Extend', 'c2Retract', '2E', '2R', '2S');
            controls.makeHoldButton('c3Extend', 'c3Retract', '3E', '3R', '3S');

            // Auger click handlers
            $('augerForward').onclick = () => controls.augerAction('4F', 'run FORWARD');
            $('augerReverse').onclick = () => controls.augerAction('4R', 'run REVERSE');
            $('stopAll').onclick     = controls.emergencyStop;

            // Connection buttons
            $('scanBtn').onclick      = ble.connect;
            $('disconnectBtn').onclick = ble.disconnect;

            // Initial UI state
            updateUI();
            setStatus('Ready – tap SCAN DEVICE to start');
        }

        function updateUI() {
            deviceStatusEl.textContent = appState.deviceName 
                ? `Connected: ${appState.deviceName}` 
                : "Not connected";
            
            $('disconnectBtn').disabled = !appState.deviceName;
            document.querySelectorAll('.btn-control')
                .forEach(b => b.disabled = !appState.deviceName);
        }

        // Start everything
        init();

        // Export for potential debugging / console usage
        window.appDebug = { ble, controls, appState };
    </script>
</body>
</html>
